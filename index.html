<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuna ä»£è³¼ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* é¦–é æŒ‰éˆ•æ¨£å¼ */
        #homePage { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; gap: 20px; padding: 20px; }
        .main-btn { width: 100%; max-width: 300px; height: 100px; border-radius: 20px; border: none; font-size: 20px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .main-btn:active { transform: scale(0.95); }
        .btn-add { background: var(--primary); font-size: 40px; }
        .btn-list { background: #673ab7; }
        .btn-cust { background: #ff9800; }

        /* é é¢å®¹å™¨ */
        .sub-page { display: none; padding: 20px; }
        .sub-page.active { display: block; }
        .header-bar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { background: #ddd; border: none; padding: 8px 15px; border-radius: 8px; font-size: 14px; }

        /* è¡¨å–®èˆ‡å¡ç‰‡ */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-opt { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .btn-opt.active { background: var(--primary); color: white; border-color: var(--primary); }
        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 10px; }

        /* åˆ—è¡¨æ¨£å¼ */
        .item-row { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; gap: 12px; position: relative; }
        .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
        .item-info { flex: 1; font-size: 14px; }
        .del-x { position: absolute; right: 10px; top: 10px; color: #ccc; border: none; background: none; font-size: 20px; }

        /* åˆ†é¡æ¨£å¼ */
        .cust-box { background: white; border-radius: 12px; margin-bottom: 10px; overflow: hidden; }
        .cust-name { background: #eee; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="homePage">
        <h1 style="margin-bottom: 30px; color: #333;">Yuna ä»£è³¼å·¥å…·</h1>
        <button class="main-btn btn-add" onclick="showPage('part1')"><span>ï¼‹</span></button>
        <button class="main-btn btn-list" onclick="showPage('part2')">ğŸ“‹ è³¼è²·æ˜ç´°</button>
        <button class="main-btn btn-cust" onclick="showPage('part3')">ğŸ‘¥ é¡§å®¢åˆ†é¡</button>
    </div>

    <div id="part1" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">æ–°å¢è³¼è²·ç´€éŒ„</h2>
        </div>
        <div class="card">
            <div class="form-group"><label>ç…§ç‰‡</label><input type="file" id="pImg" accept="image/*"></div>
            <div class="form-group"><label>å“å</label><input type="text" id="pName"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>æœªç¨…</label><input type="text" id="pPriceN"></div>
                <div class="form-group" style="flex:1"><label>å«ç¨…</label><input type="text" id="pPriceTax"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>æ•¸é‡</label><input type="number" id="pQty" value="1"></div>
                <div class="form-group" style="flex:1"><label>é€€ç¨…%</label><input type="number" id="pTaxRate" value="10"></div>
            </div>
            <div class="form-group"><label>è³¼è²·åœ°é»</label><input type="text" id="pLoc"></div>
            <div class="form-group"><label>é¡§å®¢å</label><input type="text" id="pCustomer"></div>
            <div class="form-group">
                <label>ç”±èª°è³¼è²·</label>
                <div class="btn-group">
                    <button class="btn-opt" onclick="setBuyer('Ray', this)">Ray</button>
                    <button class="btn-opt" onclick="setBuyer('Nana', this)">Nana</button>
                    <button class="btn-opt" onclick="setBuyer('Cupid', this)">Cupid</button>
                </div>
                <input type="hidden" id="pBuyer">
            </div>
            <button class="submit-btn" onclick="saveData()">ğŸš€ ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <div id="part2" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">è³¼è²·æ˜ç´°æµæ°´å¸³</h2>
        </div>
        <div id="allList"></div>
    </div>

    <div id="part3" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">é¡§å®¢åˆ†é¡æ¸…å–®</h2>
        </div>
        <button onclick="exportToExcel()" style="width:100%; background:var(--success); color:white; border:none; padding:12px; border-radius:10px; margin-bottom:15px; font-weight:bold;">ğŸ“Š åŒ¯å‡ºç¸½ Excel</button>
        <div id="customerList"></div>
    </div>

    <script>
        // Firebase é…ç½® (ä¿ç•™æ‚¨çš„è³‡è¨Š)
        const firebaseConfig = {
            apiKey: "AIzaSyBxy3g2MS18oJdE2v-JAZ9VWXZwZQ9W4yM",
            databaseURL: "https://yunabuy-cf20c-default-rtdb.firebaseio.com/",
            projectId: "yunabuy-cf20c",
            appId: "1:994921038504:web:6b1c54b9a71ee425b3f89d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dataRef = db.ref('yuna_v3_data');

        let rawData = {};

        // é é¢åˆ‡æ›é‚è¼¯
        function showPage(pageId) {
            document.getElementById('homePage').style.display = (pageId === 'home') ? 'flex' : 'none';
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            if(pageId !== 'home') document.getElementById(pageId).classList.add('active');
        }

        // è²·æ‰‹é¸æ“‡
        function setBuyer(name, btn) {
            document.getElementById('pBuyer').value = name;
            document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // ç›£è½è³‡æ–™
        dataRef.on('value', (snap) => {
            rawData = snap.val() || {};
            renderLists();
        });

        // å„²å­˜
        async function saveData() {
            const file = document.getElementById('pImg').files[0];
            let base64 = "";
            if(file) {
                base64 = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const payload = {
                name: document.getElementById('pName').value || "æœªåå•†å“",
                priceN: document.getElementById('pPriceN').value,
                priceTax: document.getElementById('pPriceTax').value,
                qty: document.getElementById('pQty').value,
                taxRate: document.getElementById('pTaxRate').value,
                loc: document.getElementById('pLoc').value,
                customer: document.getElementById('pCustomer').value || "æ•£å®¢",
                buyer: document.getElementById('pBuyer').value,
                img: base64,
                time: new Date().toLocaleString()
            };

            dataRef.push(payload);
            alert("å·²æˆåŠŸæ–°å¢ï¼");
            showPage('home');
            // é‡ç½®
            ['pName','pPriceN','pPriceTax','pCustomer','pLoc','pImg'].forEach(id => document.getElementById(id).value = '');
        }

        function renderLists() {
            const listArr = Object.entries(rawData).map(([id, val]) => ({ id, ...val })).reverse();
            
            // æ¸²æŸ“æµæ°´å¸³
            document.getElementById('allList').innerHTML = listArr.map(i => `
                <div class="item-row">
                    <img src="${i.img || 'https://via.placeholder.com/60'}" class="item-img">
                    <div class="item-info">
                        <b>${i.name}</b> (${i.qty})<br>
                        <span style="font-size:12px; color:#666;">å®¢: ${i.customer} | è²·: ${i.buyer}</span><br>
                        <span style="font-size:12px; color:#666;">ğŸ’° ${i.priceTax} | ğŸ“ ${i.loc}</span>
                    </div>
                    <button class="del-x" onclick="if(confirm('åˆªé™¤ï¼Ÿ')) dataRef.child('${i.id}').remove()">âœ•</button>
                </div>
            `).join('');

            // æ¸²æŸ“é¡§å®¢åˆ†é¡
            const groups = {};
            listArr.forEach(i => {
                if(!groups[i.customer]) groups[i.customer] = [];
                groups[i.customer].push(i);
            });
            document.getElementById('customerList').innerHTML = Object.keys(groups).map(c => `
                <div class="cust-box">
                    <div class="cust-name"><span>ğŸ‘¤ ${c}</span> <span>${groups[c].length}ä»¶</span></div>
                    <div style="padding:10px; font-size:13px;">
                        ${groups[c].map(p => `â€¢ ${p.name} (${p.priceTax}å…ƒ)`).join('<br>')}
                    </div>
                </div>
            `).join('');
        }

        function exportToExcel() {
            const exportData = Object.values(rawData).map(i => ({
                "æ™‚é–“": i.time, "é¡§å®¢": i.customer, "å“å": i.name, "æ•¸é‡": i.qty,
                "å«ç¨…åƒ¹": i.priceTax, "åœ°é»": i.loc, "è²·æ‰‹": i.buyer
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ¡è³¼ç¸½è¡¨");
            XLSX.writeFile(wb, `ä»£è³¼æ¸…å–®_${new Date().toLocaleDateString()}.xlsx`);
        }
    </script>
</body>
</html>
