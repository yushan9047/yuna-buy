<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuna ä»£è³¼ç®¡ç†ç³»çµ± v4</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4a90e2; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* é¦–é å„€è¡¨æ¿ */
        #homePage { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; gap: 20px; padding: 20px; }
        .main-btn { width: 100%; max-width: 300px; height: 100px; border-radius: 20px; border: none; font-size: 20px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-add { background: var(--primary); font-size: 40px; }
        .btn-list { background: #673ab7; }
        .btn-cust { background: #ff9800; }

        /* å­é é¢ */
        .sub-page { display: none; padding: 15px; padding-bottom: 50px; }
        .sub-page.active { display: block; }
        .header-bar { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .back-btn { background: #ddd; border: none; padding: 8px 12px; border-radius: 8px; font-size: 14px; }

        /* è¡¨å–® */
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-group { display: flex; gap: 8px; }
        .btn-opt { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; }
        .btn-opt.active { background: var(--primary); color: white; border-color: var(--primary); }
        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 10px; }

        /* æ˜ç´°åˆ—è¡¨ - æ”¯æ´ç·¨è¼¯çš„æ¨£å¼ */
        .item-row { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; gap: 12px; position: relative; border-left: 5px solid #673ab7; }
        .item-img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; }
        .item-info { flex: 1; font-size: 14px; line-height: 1.6; }
        .editable-field { border-bottom: 1px dashed #ccc; padding: 1px 4px; cursor: pointer; color: #4a90e2; font-weight: 500; }
        .editable-field:hover { background: #f9f9f9; }
        .del-x { position: absolute; right: 10px; top: 10px; color: #ddd; border: none; background: none; font-size: 20px; padding: 5px; }

        /* åˆ†é¡æ¨£å¼ */
        .cust-box { background: white; border-radius: 12px; margin-bottom: 10px; overflow: hidden; border: 1px solid #ddd; }
        .cust-name { background: #f8f9fa; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="homePage">
        <h1 style="margin-bottom: 25px; color: #333; letter-spacing: 1px;">ğŸ›ï¸ Yuna ä»£è³¼ç³»çµ±</h1>
        <button class="main-btn btn-add" onclick="showPage('part1')"><span>ï¼‹</span></button>
        <button class="main-btn btn-list" onclick="showPage('part2')">ğŸ“‹ è³¼è²·æ˜ç´°</button>
        <button class="main-btn btn-cust" onclick="showPage('part3')">ğŸ‘¥ é¡§å®¢åˆ†é¡</button>
    </div>

    <div id="part1" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">ğŸ“¸ æ–°å¢é€£ç·šç´€éŒ„</h2>
        </div>
        <div class="card">
            <div class="form-group"><label>ç…§ç‰‡</label><input type="file" id="pImg" accept="image/*"></div>
            <div class="form-group"><label>å“å</label><input type="text" id="pName" placeholder="å•†å“åç¨±"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>æœªç¨…åƒ¹</label><input type="text" id="pPriceN"></div>
                <div class="form-group" style="flex:1"><label>å«ç¨…åƒ¹</label><input type="text" id="pPriceTax"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>æ•¸é‡</label><input type="number" id="pQty" value="1"></div>
                <div class="form-group" style="flex:1"><label>é€€ç¨…%</label><input type="number" id="pTaxRate" value="10"></div>
            </div>
            <div class="form-group"><label>è³¼è²·åœ°é»</label><input type="text" id="pLoc" placeholder="ä¾‹å¦‚ï¼šå¤§ä¸¸ç™¾è²¨"></div>
            <div class="form-group"><label>é¡§å®¢å</label><input type="text" id="pCustomer" placeholder="å®¢äººå§“å"></div>
            <div class="form-group">
                <label>ç”±èª°è³¼è²·</label>
                <div class="btn-group">
                    <button class="btn-opt" onclick="setBuyer('Ray', this)">Ray</button>
                    <button class="btn-opt" onclick="setBuyer('Nana', this)">Nana</button>
                    <button class="btn-opt" onclick="setBuyer('Cupid', this)">Cupid</button>
                </div>
                <input type="hidden" id="pBuyer">
            </div>
            <button class="submit-btn" onclick="saveData()">âœ… ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <div id="part2" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">ğŸ“‹ æ¡è³¼æ˜ç´° (é»æ“Šæ–‡å­—å¯ä¿®æ”¹)</h2>
        </div>
        <div id="allList"></div>
    </div>

    <div id="part3" class="sub-page">
        <div class="header-bar">
            <button class="back-btn" onclick="showPage('home')">â† è¿”å›</button>
            <h2 style="margin:0">ğŸ‘¥ é¡§å®¢çµ±è¨ˆ</h2>
        </div>
        <button onclick="exportToExcel()" style="width:100%; background:var(--success); color:white; border:none; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; font-size:16px;">ğŸ“Š åŒ¯å‡ºç¸½ Excel</button>
        <div id="customerList"></div>
    </div>

    <script>
        // Firebase é…ç½® (ä¿ç•™æ‚¨çš„è³‡è¨Š)
        const firebaseConfig = {
            apiKey: "AIzaSyBxy3g2MS18oJdE2v-JAZ9VWXZwZQ9W4yM",
            databaseURL: "https://yunabuy-cf20c-default-rtdb.firebaseio.com/",
            projectId: "yunabuy-cf20c",
            appId: "1:994921038504:web:6b1c54b9a71ee425b3f89d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dataRef = db.ref('yuna_v4_data'); // ä½¿ç”¨æ–°è·¯å¾‘ä»¥é˜²è³‡æ–™è¡çª

        let rawData = {};

        function showPage(pageId) {
            document.getElementById('homePage').style.display = (pageId === 'home') ? 'flex' : 'none';
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            if(pageId !== 'home') document.getElementById(pageId).classList.add('active');
        }

        function setBuyer(name, btn) {
            document.getElementById('pBuyer').value = name;
            document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        dataRef.on('value', (snap) => {
            rawData = snap.val() || {};
            renderLists();
        });

        async function saveData() {
            const file = document.getElementById('pImg').files[0];
            let base64 = "";
            if(file) {
                base64 = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const payload = {
                name: document.getElementById('pName').value || "æœªåå•†å“",
                priceN: document.getElementById('pPriceN').value || "0",
                priceTax: document.getElementById('pPriceTax').value || "0",
                qty: document.getElementById('pQty').value || "1",
                taxRate: document.getElementById('pTaxRate').value || "10",
                loc: document.getElementById('pLoc').value || "",
                customer: document.getElementById('pCustomer').value || "æ•£å®¢",
                buyer: document.getElementById('pBuyer').value || "æœªæŒ‡å®š",
                img: base64,
                time: new Date().toLocaleString()
            };

            dataRef.push(payload);
            alert("å„²å­˜æˆåŠŸï¼");
            showPage('home');
            ['pName','pPriceN','pPriceTax','pCustomer','pLoc','pImg'].forEach(id => document.getElementById(id).value = '');
        }

        // ç·¨è¼¯æ ¸å¿ƒåŠŸèƒ½
        function quickEdit(id, field, currentVal) {
            let promptMsg = {
                'name': 'è«‹è¼¸å…¥æ–°çš„å“åï¼š',
                'qty': 'è«‹è¼¸å…¥æ–°çš„æ•¸é‡ï¼š',
                'priceTax': 'è«‹è¼¸å…¥æ–°çš„å«ç¨…ç¸½åƒ¹ï¼š',
                'customer': 'è«‹è¼¸å…¥æ–°çš„é¡§å®¢å§“åï¼š',
                'buyer': 'è«‹è¼¸å…¥è²·æ‰‹ (Ray/Nana/Cupid)ï¼š'
            };
            
            const newValue = prompt(promptMsg[field] || 'è«‹è¼¸å…¥æ–°æ•¸å€¼ï¼š', currentVal);
            
            if (newValue !== null && newValue.trim() !== "") {
                const updateData = {};
                updateData[field] = newValue;
                dataRef.child(id).update(updateData);
            }
        }

        function renderLists() {
            const listArr = Object.entries(rawData).map(([id, val]) => ({ id, ...val })).reverse();
            
            // æ¸²æŸ“æ˜ç´° (åŠ ä¸Šå¯ç·¨è¼¯å±¬æ€§)
            document.getElementById('allList').innerHTML = listArr.map(i => `
                <div class="item-row">
                    <img src="${i.img || 'https://via.placeholder.com/70'}" class="item-img" onclick="window.open(this.src)">
                    <div class="item-info">
                        <span class="editable-field" onclick="quickEdit('${i.id}', 'name', '${i.name}')">${i.name}</span> 
                        x <span class="editable-field" onclick="quickEdit('${i.id}', 'qty', '${i.qty}')">${i.qty}</span><br>
                        
                        å®¢ï¼š<span class="editable-field" onclick="quickEdit('${i.id}', 'customer', '${i.customer}')">${i.customer}</span> | 
                        è²·æ‰‹ï¼š<span class="editable-field" onclick="quickEdit('${i.id}', 'buyer', '${i.buyer}')">${i.buyer}</span><br>
                        
                        ğŸ’° å«ç¨…ï¼š<span class="editable-field" onclick="quickEdit('${i.id}', 'priceTax', '${i.priceTax}')">${i.priceTax}</span> | 
                        ğŸ“ ${i.loc || 'æœªè¨»æ˜'}<br>
                        
                        <span style="font-size:10px; color:#aaa;">ğŸ•’ ${i.time}</span>
                    </div>
                    <button class="del-x" onclick="if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) dataRef.child('${i.id}').remove()">âœ•</button>
                </div>
            `).join('');

            // æ¸²æŸ“é¡§å®¢åˆ†é¡
            const groups = {};
            listArr.forEach(i => {
                if(!groups[i.customer]) groups[i.customer] = [];
                groups[i.customer].push(i);
            });
            document.getElementById('customerList').innerHTML = Object.keys(groups).map(c => `
                <div class="cust-box">
                    <div class="cust-name"><span>ğŸ‘¤ ${c}</span> <span>${groups[c].length} ä»¶å•†å“</span></div>
                    <div style="padding:10px; font-size:13px; line-height:1.8;">
                        ${groups[c].map(p => `â€¢ <b>${p.name}</b> (${p.qty}ä»¶) - ${p.priceTax}å…ƒ`).join('<br>')}
                        <div style="margin-top:8px; border-top:1px solid #eee; padding-top:5px; text-align:right; font-weight:bold; color:var(--danger);">
                            å°è¨ˆ: ${groups[c].reduce((sum, item) => sum + (parseFloat(item.priceTax)||0), 0)} å…ƒ
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function exportToExcel() {
            const exportData = Object.values(rawData).map(i => ({
                "æ™‚é–“": i.time, "é¡§å®¢": i.customer, "å“å": i.name, "æ•¸é‡": i.qty,
                "å«ç¨…åƒ¹": i.priceTax, "åœ°é»": i.loc, "è²·æ‰‹": i.buyer, "é€€ç¨…%": i.taxRate
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ¡è³¼ç¸½è¡¨");
            XLSX.writeFile(wb, `Yunaä»£è³¼ç´€éŒ„_${new Date().toLocaleDateString()}.xlsx`);
        }
    </script>
</body>
</html>
